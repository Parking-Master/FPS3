<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS3 - Multiplayer First Person Shooter game</title>
    <style>
      @font-face {
        font-family: "Roboto";
        src: url(fonts/Roboto.ttf);
      }
      @font-face {
        font-family: "Game";
        src: url(fonts/Game.ttf);
      }
      html, body {
        font-family: "Roboto", Arial;
        overflow: hidden !important;
        user-select: none !important;
        background-image: linear-gradient(to right, #fff, #ddd);
      }
      .wrapper {
        width: 98%;
        height: 97%;
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1), 0 1px 8px rgba(0, 0, 0, 0.3);
        padding: 0 !important;
        border: 5px solid #333;
        border-image: linear-gradient(to top, #333, #fff) 1 / 20px;
        background: #fefefe;
      }
      h1 {
        text-align: center;
        font-size: 9em;
        margin: 0;
        color: #fff;
        text-shadow: 2.5px 2.5px 10px rgba(0, 0, 0, 0.25);
        z-index: 5;
        font-family: "Game", Arial, Helvetica, sans-serif !important;
        padding: 10px 0;
      }
      h2 {
        position: relative;
        text-align: center;
        font-size: 7em;
        margin: 0;
        color: #fff;
        text-shadow: 2.5px 2.5px 10px rgba(0, 0, 0, 0.25);
        background: #fefefe;
        z-index: 500 !important;
        width: 300px;
        left: 50%;
        margin-left: -150px;
        font-family: "Game", Arial, Helvetica, sans-serif !important;
        font-style: italic;
      }
      .main-image {
        width: 45vh;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%);
        filter: drop-shadow(3px 3px 3px rgba(0, 0, 0, .3)) contrast(120%);
      }
      .strike {
        width: 30%;
        height: 4px;
        position: absolute;
        background: #333;
        top: 12%;
      }
      .strike.str-left {
        left: 5%;
      }
      .strike.str-right {
        right: 5%;
      }
      button.button {
        position: relative;
        padding: 20px 8px;
        width: 250px;
        border-radius: 10px;
        background: #fff;
        border: 3px solid #333;
        font-size: 18px;
        font-family: "Open Sans Light", Arial;
        font-weight: 100;
        font-size: 18px;
        margin-left: 5%;
        margin-bottom: 20vh;
        transition: transform .1s;
        white-space: nowrap;
        text-transform: uppercase;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1), 0 1px 8px rgba(0, 0, 0, 0.3);
        transition: box-shadow 1s;
        cursor: pointer;
      }
      button.button:hover {
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1), 0 1px 12px rgba(0, 0, 0, 0.35);
      }
      button.button:active {
        transition: box-shadow .3s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.2);
      }
      [class^="loader-"] {
        background: #333;
        height: 100vh;
        position: fixed;
        margin: 0 !important;
        left: 0;
        top: 0;
        z-index: 9999999;
        width: 0;
      }
      .loader-1 {
        width: 200px;
        transition: left 1s ease-in;
      }
      .loader-2 {
        width: 100px;
        transition: left 1.1s ease-in;
      }
      .loader-3 {
        width: 50px;
        transition: left 1.2s ease-in;
      }
      .loader-4 {
        width: 25px;
        transition: left 1.3s ease-in;
      }
      .loader-5 {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: #111;
        width: 100%;
        height: 100%;
        margin: 0 !important;
        opacity: 1;
        transition: background 2s, backdrop-filter 2s;
        backdrop-filter: blur(15px);
      }
      img {
        pointer-events: none !important;
      }
      .notiflix-confirm-overlay {
        backdrop-filter: blur(5px);
      }
      .notiflix-confirm-head * {
        color: #333 !important;
      }
      .notiflix-confirm-buttons a {
        background: #333 !important;
        border-radius: 2px !important;
      }
      .notiflix-confirm-content {
        border-radius: 5px !important;
      }
      @media only screen and (max-height: 640px) {
        h1 {
          visibility: hidden;
        }
      }
      .arrow {
        border: solid #333;
        border-width: 0 3px 3px 0;
        display: inline-block;
        padding: 3px;
      }
      .hidden-list {
        height: 0;
        margin-top: 10px;
        transition: height .2s, box-shadow 1s;
        visibility: hidden;
        cursor: default !important;
      }
      .mini-button {
        text-decoration: underline;
        text-transform: capitalize;
      }
      .carousel .arrow-holder:hover {
        outline: 1px solid currentColor;
      }
      a {
        cursor: pointer;
      }
    </style>
  </head>
	<script src="https://cdn.jsdelivr.net/gh/Parking-Master/Gametime.js-2.0@latest/gametime.js"></script>
  <body>
    <div class="loader">
      <div class="loader-5"></div>
    </div>
    <div class="wrapper">
      <h2 style="margin-top: 2%">FPS</h2>
      <h1 style="margin-top: -2%">3</h1>
      <div class="strike str-left"></div>
      <div class="strike str-right"></div>
      <img src="images/html/mastery.png" class="main-image" style="margin-top: -60px">
      <div style="margin-top: -100px">
        <button style="position: absolute" class="hidden-list button">
          <br>
          <br>
          <b style="font-family: Arial, Helvetica, sans-serif !important; font-weight: bold; font-size: 12px">Select a mode:</b>
          <br>
          <a id="mode" onclick="event.preventDefault()" class="carousel"><span class="arrow-holder" onclick="switchMode(this, 'back')"><i class="arrow" style="transform: rotate(135deg)"></i></span> <span class="holder">Slayer</span> <span class="arrow-holder" onclick="switchMode(this, 'go')"><i class="arrow" style="transform: rotate(-45deg)"></i></span></a>
          <br>
          <a class="mini-button" style="margin: 0; font-family: monospace" onclick="start()">Start</a>
        </button>
        <button onclick="play(this)" class="button">play</button>
        <button style="margin-left:0;position:absolute;margin-right:5%!important;right:0!important" onclick="customize()" class="button">options</button>
        <br>
        <button onclick="multiplayer()" class="button">store</button>
        <button style="margin-left:0;position:absolute;margin-right:5%!important;right:0!important" class="button">help</button>
      </div>
      <p class="copyright" style="position: absolute; text-align: center; margin: 0; top: 90%; font-size: 20px; width: 300px; left: 50%; margin-left: -150px; padding: 0">&copy; 2023 Parking-Master</p>
    </div>
    <script>
      /* importers */
      import("https://cdn.jsdelivr.net/gh/notiflix/Notiflix@latest/dist/notiflix-aio-3.2.5.min.js");
      import("./js/SessionSearcher.js");

      gametime.set("key", "pub-c-c44c8fc4-612e-4fc3-b875-4398f01da63c", "sub-c-b6832794-3c08-11ec-b2c1-a25c7fcd9558");
      gametime.set("channel", "world");

      availableModes = ["Slayer", "Teams", "Fiesta", "Snipers", "Oddball", "Fistfight", "CTF", "KOTH"];
      availableMaps = ["Cargo", "Storage", "Vertice", "Lihid", "Aero"];
      currentMode = availableModes[0];
      
      function loader(rate = 200) {
        let loader1 = document.createElement("div");
        let loader2 = document.createElement("div");
        let loader3 = document.createElement("div");
        let loader4 = document.createElement("div");
        let loader5 = document.createElement("div");
        loader1.className = "loader-1";
        document.querySelector(".loader").appendChild(loader1);
        loader2.className = "loader-2";
        document.querySelector(".loader").appendChild(loader2);
        loader3.className = "loader-3";
        document.querySelector(".loader").appendChild(loader3);
        loader4.className = "loader-4";
        document.querySelector(".loader").appendChild(loader4);
        loader5.className = "loader-5";
        document.querySelector(".loader-5") == null && document.querySelector(".loader").appendChild(loader5);
        document.querySelector(".loader-5").style.background = "#111";
        document.querySelector(".loader-5").style.backdropFilter = "blur(15px)";
        document.querySelector(".loader-2").style.left = "0";
        document.querySelector(".loader-1").style.left = "0";
        document.querySelector(".loader-1").style.left = "200%";
        setTimeout(() => {
          document.querySelector(".loader-5").style.background = "transparent";
          document.querySelector(".loader-5").style.backdropFilter = "none";
          document.querySelector(".loader-2").style.left = "200%";
          setTimeout(() => {
            loader1.remove();
            loader2.remove();
            loader3.remove();
            loader4.remove();
            document.querySelector(".loader-5").remove();
          }, 2100);
          setTimeout(() => {
            document.querySelector(".loader-3").style.left = "200%";
          }, rate);
          setTimeout(() => {
            document.querySelector(".loader-4").style.left = "200%";
          }, rate);
        }, rate);
      }
      window.addEventListener("load", () => {
        loader();
      });
      function play(button) {
        typeof button.clicked == "undefined" ? button.clicked = false : void(0);
        if (button.clicked) {
          button.querySelectorAll(".arrow").forEach(x => {
            x.style.transform = "rotate(-45deg)";
            setTimeout(() => {
              x.remove();
            }, 250);
          });
          document.querySelector(".hidden-list").style.height = "0";
          document.querySelector(".hidden-list").style.visibility = "hidden";
          button.style.borderBottom = "";
          button.style.borderBottomLeftRadius = "";
          button.style.borderBottomRightRadius = "";
          button.style.clipPath = "";
          button.style.boxShadow = "";
          return button.clicked = false;
        }
        let i = document.createElement("i");
        i.className = "arrow";
        i.style = "transform: rotate(-45deg); transition: transform .2s; margin-left: 10px";
        button.appendChild(i);
        document.querySelector(".hidden-list").style.height = "150px";
        document.querySelector(".hidden-list").style.visibility = "visible";
        setTimeout(() => {
          i.style.transform = "rotate(45deg)";
        }, 100);
        button.style.borderBottom = "1px dashed #999";
        button.style.borderBottomLeftRadius = "0";
        button.style.borderBottomRightRadius = "0";
        button.style.clipPath = "inset(-5px -5px 0px -5px)";
        button.style.boxShadow = "none";
        button.clicked = true;
      }
      function start() {
        Session.create({
          mode: currentMode,
          map: availableMaps[Math.floor(Math.random() * availableMaps.length)],
          active: false
        });
        currentObjectId = null;
        gametime.make("join");
        gametime.make("joined");
        gametime.on("joined", function(data) {
          let extend = new Parse.Object.extend("Lobby");
          let lobby = new extend();
          lobby.set("objectId", data.split(",")[0]);
          document.querySelector(".notiflix-confirm-head").querySelector("h5").textContent = "Match found!";
          document.querySelector(".notiflix-confirm-head").querySelector("div").textContent = "Connecting players... (1/2)";
          setTimeout(() => document.querySelector(".notiflix-confirm-head").querySelector("div").textContent = "Connecting players... (2/2)", 500);
          setTimeout(() => location.assign("./src.html?lobby=" + lobby.get("sessionId") + "&mode=" + lobby.get("query").mode + "&map=" + lobby.get("query").map), 3000);
        });
        gametime.on("join", function(data) {
          if (data.split(",")[0] == gametime.user.position) return;
          let extend = new Parse.Object.extend("Lobby");
          let lobby = new extend();
          lobby.set("objectId", currentObjectId);
          if (data.split(",")[1] == Session.getIds()[Session.getIds().length - 1]) {
            gametime.run("joined", [data.split(",")[2]]);
          }
        });
        Notiflix.Confirm.show("Searching for a match...", "Please wait for the game to start.", "Cancel");
        document.querySelector(".notiflix-confirm-head").querySelector("div").innerHTML += "<br><br><a href='./src.html?freeplay=true&mode=" + currentMode + "&map=" + availableMaps[Math.floor(Math.random() * availableMaps.length)] + "'>Free play</a>";
        document.querySelector("#NXConfirmButtonOk").onclick = () => {
          clearInterval(search);
          Session.clearCache();
          navigator.sendBeacon("https://parseapi.back4app.com/classes/Lobby/" + currentObjectId, JSON.stringify({"_method":"DELETE","_ApplicationId":"NTR81WnvZ9NPy2JNigjx1OQS9BG41TrmSHD6z2ap","_JavaScriptKey":"4xIHZYPRyPpBcBR7bQOY3IKV1VlCFbZRoH6hSrp7","_ClientVersion":"js3.4.4","_InstallationId":"ec732c40-e273-4e15-909f-ba1541651a8c"}));
        };
        let search = setInterval(() => {
          Session.search().then(x => {
            x.forEach(object => {
              gametime.run("join", [gametime.user.position + "," + object.sessionId + "," + object.id]);
            });
          });
        }, 5000);
        window.onbeforeunload = function(e) {
          navigator.sendBeacon("https://parseapi.back4app.com/classes/Lobby/" + currentObjectId, JSON.stringify({"_method":"DELETE","_ApplicationId":"NTR81WnvZ9NPy2JNigjx1OQS9BG41TrmSHD6z2ap","_JavaScriptKey":"4xIHZYPRyPpBcBR7bQOY3IKV1VlCFbZRoH6hSrp7","_ClientVersion":"js3.4.4","_InstallationId":"ec732c40-e273-4e15-909f-ba1541651a8c"}));
          return null;
        }
      }
      function switchMode(element, type) {
        let index = availableModes.indexOf(currentMode);
        if (type == "back") {
          if (index - 1 < 0) {
            index = availableModes.length - 1;
          } else {
            index--;
          }
        } else {
          if (index + 1 > (availableModes.length - 1)) {
            index = 0;
          } else {
            index++;
          }
        }
        currentMode = availableModes[index];
        element.parentElement.querySelector(".holder").textContent = currentMode;
      }
    </script>
  </body>
</html>