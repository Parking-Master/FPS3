<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit settings</title>
    <style>
      @font-face {
        font-family: "Roboto";
        src: url(fonts/Roboto.ttf);
      }
      @font-face {
        font-family: "Game";
        src: url(fonts/Game.ttf);
      }
      html, body {
        font-family: "Roboto", Arial;
        user-select: none !important;
      }
      .body {
        width: 98%;
        height: 97%;
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1), 0 1px 8px rgba(0, 0, 0, 0.3);
        padding: 0 !important;
        border: 5px solid #333;
        border-image: linear-gradient(to top, #333, #fff) 1 / 20px;
        background: #fefefe;
      }
      .card {
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        transition: box-shadow .3s;
        width: 162px !important;
        border-radius: 5px;
        margin: 10px;
        display: inline-block;
        cursor: pointer;
      }
      .card.hot {
        border: 2px solid #333;
        border-image: linear-gradient(to right, #333, #fff) 1 / 2px;
      }
      .card:hover {
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
      }
      img {
        border-radius: 5px 5px 0 0;
        pointer-events: none;
      }
      .container {
        padding: 2px 16px;
      }
      .light {
        font-size: italic;
        color: #999;
      }
      .wrapper {
        display: inline-flex;
        align-items: left;
        justify-content: left;
        position: absolute;
        top: 50%;
        left: 5% !important;
        transform: translate(0, -50%);
        flex-wrap: wrap;
        width: 70%;
      }
      .credit {
        vertical-align: baseline;
        width: 6%;
      }
      .price {
        color: #333;
        vertical-align: baseline;
      }
      .strike {
        text-decoration: line-through;
        filter: brightness(0%);
      }
      .sale {
        width: 15%;
        vertical-align: middle;
      }
      .user-points {
        border-bottom: 2px solid #333;
      }
      h1.title, p.description {
        text-shadow: 2.5px 2.5px 10px rgba(0, 0, 0, 0.25);
      }
      button {
        padding: 2px;
        border: 1px solid #333;
        background: #fff;
        margin: 5px;
        border-radius: 2px;
        cursor: pointer;
      }
      button:hover {
        background: #eee;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes spin-reverse {
        0% {
          transform: rotate(360deg);
        }
        100% {
          transform: rotate(0deg);
        }
      }
      .spin {
        border: 2px solid #f3f3f3;
        display: inline-block;
        border-top: 2px solid #333;
        border-radius: 50%;
        width: 10px;
        height: 10px;
        margin-left: 15px;
        animation: spin 2s linear infinite;
      }
      .spin-reverse {
        animation: spin-reverse 2s linear infinite;
      }
      .spin.spin-large {
        width: 100px;
        height: 100px;
      }
      .center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .loader {
        background: #fff;
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        margin: 0;
        z-index: 999999999;
      }
      .center-origin {
        display: inline-flex;
        text-align: center;
        align-items: center;
        justify-content: center;
      }
      video {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        z-index: 999999;
        margin: 0 !important;
        border: none;
      }
      #clearfix {
        outline: none;
        border: none;
        background: #fff;
        color: #333;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.24) !important;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.24) !important;
        font-size: 18px;
        padding: 6px;
        border-radius: 3px;
        cursor: pointer;
      }
      canvas {
        position: absolute;
        left : 0;
        top: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
      }
    </style>
    <script src="js/user/user.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/notiflix/Notiflix@latest/dist/notiflix-aio-3.2.5.min.js"></script>
  </head>
  <body>
    <audio id="walking" src="sounds/walking.mp3" loop></audio>
    <script src="https://threejs.org/build/three.min.js"></script>
    <script src="js/GLTFLoader.min.js"></script>
    <script src="js/fflate.min.js"></script>
    <div class="loader">
      <div class="spin spin-large center-origin" style="position: absolute; left: 50%; top: 50%; margin-left: -50px; margin-top: -50px; padding: 0 !important">
        <p class="spin-reverse" style="display: inline-block"><img src="images/html/settings.png" style="width: 50%"></p>
      </div>
    </div>
    <div class="body">
      <h1 style="text-align: center; font-size: 3em" class="title"><img class="credit" src="images/html/settings.png" style="width: 2%; vertical-align: baseline"> Settings</h1>
      <p style="text-align: center" class="description">You currently own <span class="user-items">0</span> items, with <span class="user-points">0</span> available credit(s)</h1>
      <div class="wrapper">
        <div class="card" data-item="Loadout" data-price="300">
          <img src="images/store/loadouts/Assault_Rifle-Glock_19.png" style="width:100%">
          <div class="container">
            <h4><b>Basic</b></h4>
            <p>My loadout</p>
          </div>
        </div>
        <div class="card" data-item="Theme" data-price="9000">
          <img src="images/store/themes/default.png" style="width:100%">
          <div class="container">
            <h4><b>Default</b></h4>
            <p>My theme</p>
          </div>
        </div>
        <div class="card" data-item="Character" data-price="550">
          <img src="images/store/characters/Steve.png" style="width:100%">
          <div class="container">
            <h4><b>Steve</b></h4>
            <p>Character</p>
          </div>
        </div>
        <div class="card" data-item="Bots" data-price="550">
          <img src="images/store/bots.png" style="width:100%">
          <div class="container">
            <h4><b>Auto set</b></h4>
            <p>Bots</p>
          </div>
        </div>
      </div>
    </div>
    <div class="bypass" style="display: none; z-index: 999999999999999999999999; position: fixed; left: 0; top: 0; bottom: 0; right: 0; width: 100%; height: 100%; padding: 0; margin: 0; background: rgba(0, 0, 0, .435)">
      <div style="z-index: 9999999999999999; color: #fff; display: inline-block; font-size: 35px; position: fixed; left: 50%; width: 60%; margin-left: -30%; top: 50%; height: 60%; margin-top: -10%; text-align: center; justify-content: center; align-items: center">You must have an account to change settings.
        <br>
        <br>
        <button id="clearfix" onclick="location.replace('login.html?return=settings.html')">Log in</button>
      </div>
    </div>
    <script>
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.VSMShadowMap;
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.shadowMap.autoUpdate = false;
      document.body.appendChild(renderer.domElement);
      let mixers = [];
      let clock = new THREE.Clock();
      function animate() {
        requestAnimationFrame(animate);
        let delta = clock.getDelta();
        mixers.forEach(x => x.update(delta));
        renderer.render(scene, camera);
      }
      animate();
      renderer.setClearAlpha();
      renderer.setClearColor(0x000000, 0);
	    THREE.Sound = function Sound(source = null, object = new THREE.Object3D, callback = function(sound) {}, preserve3d = true, volume = 5, loop) {
        if (!preserve3d) {
          let sound = document.createElement("audio");
          sound.src = source;
          sound.play();
          loop && (sound.loop = loop);
          return;
        }
	      typeof camera.getObjectByProperty("type", "AudioListener") == "undefined" && camera.add(new THREE.AudioListener());
		    let sound = new THREE.PositionalAudio(camera.getObjectByProperty("type", "AudioListener"));
		    new THREE.AudioLoader().load(source, (buffer) => {
		      sound.setBuffer(buffer);
		      sound.setRefDistance(5);
		      sound.setVolume(volume);
		      callback(sound);
		      sound.play();
		    });
		    object.add(sound);
	    }
      const light = new THREE.DirectionalLight(0xffffff, 2);
      const ambientLight = new THREE.AmbientLight(0xeeeeee, .5);
      light.position.set(-10, 10, 0);
      light.castShadow = true;
      scene.add(ambientLight);
      scene.add(light);
      new THREE.GLTFLoader().load("models/characters/Max/scene.gltf", (e) => {
        character = e.scene;
        let mixer = new THREE.AnimationMixer(character);
        mixers.push(mixer);
        character.walking = false;
        character.walk = function() {
          if (character.walking) return (mixer.clipAction(e.animations[0]).stop(), mixer.clipAction(e.animations[0]).reset(), renderer.shadowMap.autoUpdate = false, character.walking = false, renderer.shadowMap.needsUpdate = true, document.querySelector("#walking").pause(), document.querySelector("#walking").currentTime = 0);
          document.querySelector("#walking").play();
          character.walking = true;
          renderer.shadowMap.autoUpdate = true;
          mixer.clipAction(e.animations[0]).play();
        };
        scene.add(character);
        character.position.copy(camera.position);
        character.rotation.copy(camera.rotation);
        character.translateZ(-2);
        character.rotateY(-1);
        character.position.y += -.8;
        character.position.x += 2;
        character.scale.set(1, 1.1, 1);
        new THREE.GLTFLoader().load("models/assets/floor.glb", (floor) => {
          floor = floor.scene;
          document.addEventListener("mousemove", (e) => {
            let raycaster = new THREE.Raycaster();
            let mouse = new THREE.Vector2();
            mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            let intersects = raycaster.intersectObjects([floor.getObjectByName("Walk_Button"), floor.getObjectByName("Shoot_Button")]);
            let intersection = null;
            intersects[0] && (intersection = intersects[0]);
            if (intersection) {
              document.body.style.cursor = "pointer";
              document.body.onmousedown = () => intersection.object == floor.getObjectByName("Walk_Button") ? (floor.getObjectByName("Walk_Button").translateY(-.01), character.walk()) : (floor.getObjectByName("Shoot_Button").translateY(-.01), character.shoot());
              document.body.onmouseup = () => intersection.object == floor.getObjectByName("Walk_Button") ? (floor.getObjectByName("Walk_Button").translateY(.01)) : (floor.getObjectByName("Shoot_Button").translateY(.01));
            } else {
              document.body.style.cursor = "";
              document.body.onmousedown = null;
              document.body.onmouseup = null;
            }
          });
          floor.position.copy(character.position);
          scene.add(floor);
          floor.position.y += -.25;
          character.traverse(x => (x.frustumCulled = false, x.receiveShadow = true, x.castShadow = true, renderer.shadowMap.needsUpdate = true));
          floor.traverse(x => x.receiveShadow = true);
          new THREE.GLTFLoader().load("models/weapons/dropped/Assault_Rifle.glb", (gun) => {
            gun = gun.scene;
            character.shoot = function() {
              new THREE.GLTFLoader().load("models/assets/muzzle_flash.glb", (flash) => {
                flash = flash.scene;
                new THREE.Sound("sounds/guns/Assault_Rifle/fire.mp3", gun, () => {}, false);
                // scene.add(flash);
                flash.children[0].material.opacity = 1;
                flash.scale.set(.1, .1, .1);
                flash.position.copy(gun.position);
                flash.rotation.copy(gun.rotation);
                flash.translateY(.11);
                flash.rotateY(Math.PI);
                flash.translateX(.08);
                flash.translateZ(-.3);
              });
            };
            gunHolder = new THREE.Group();
            gun.rotation.set(0, 0, 0);
            gun.position.set(0, 0, 0);
            gun.scale.set(10, 10, 10);
            gunHolder.add(gun);
            character.getObjectByName("mixamorigRightHand").add(gunHolder);
            gunHolder.rotation.set(1.5, .5, 2.9);
            gunHolder.position.set(2.4475877079089363, 22.013294147805205, 1.5569827148359332);
            gunHolder.rotateZ(.4);
            gunHolder.rotateX(-.1);
          });
        });
      });
      window.addEventListener("resize", onWindowResize);
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
      onWindowResize();
      window.addEventListener("load", () => {
        if (!userMan.isLoggedIn) return document.querySelector(".bypass").style.display = "block";
        userMan.update(["tuser", "tpass"], function(key, value) {
          if (key == "metadata") {
            document.querySelectorAll(".user-points").forEach(x => x.textContent = (value.points - 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
            document.querySelectorAll(".user-items").forEach(x => x.textContent = value.preferences.items.length);
            setTimeout(() => document.querySelector(".loader").remove(), 1000);
          }
        });
        document.querySelectorAll(".card").forEach(x => {
          x.addEventListener("click", function(event) {
            if (userMan.get("metadata").preferences.items.indexOf(x.dataset.item) > -1) {
              Notiflix.Block.circle("[data-item='" + x.dataset.item + "']", ".");
              x.querySelector(".notiflix-block-message").innerHTML = `Do you want to <b>sell</b> this item for ${((x.dataset.price - 0) / 2).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}<img class="credit" src="images/html/credit.png">?<br><button>Yes</button><button>No</button>`;
              x.querySelector(".notiflix-block-message").querySelectorAll("button")[0].addEventListener("click", function() {
                let newdata = userMan.get("metadata");
                newdata.points = newdata.points - 0;
                newdata.points += ((x.dataset.price - 0) / 2) - 0;
                newdata.points = newdata.points.toString();
                newdata.preferences.items.splice(newdata.preferences.items.indexOf(x.dataset.item), 1);
                Notiflix.Block.remove("[data-item='" + x.dataset.item + "']");
                userMan.set("metadata", newdata, () => {
                  location.reload();
                }, ["tuser", "tpass"]);
              });
              x.querySelector(".notiflix-block-message").querySelectorAll("button")[1].addEventListener("click", function() {
                Notiflix.Block.remove("[data-item='" + x.dataset.item + "']");
              });
            } else {
              Notiflix.Block.circle("[data-item='" + x.dataset.item + "']", ".");
              x.querySelector(".notiflix-block-message").innerHTML = `Do you want to <b>buy</b> this item for ${x.dataset.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}<img class="credit" src="images/html/credit.png">?<br><button>Yes</button><button>No</button>`;
              x.querySelector(".notiflix-block-message").querySelectorAll("button")[0].addEventListener("click", function() {
                let price = x.dataset.price;
                if (price - 0 >= userMan.get("metadata").points - 0) {
                  Notiflix.Notify.failure("Failed to purchase: insufficient funds.");
                  Notiflix.Block.remove("[data-item='" + x.dataset.item + "']");
                } else {
                  let newdata = userMan.get("metadata");
                  newdata.points = newdata.points - 0;
                  newdata.points -= x.dataset.price - 0;
                  newdata.points = newdata.points.toString();
                  newdata.preferences.items.push(x.dataset.item);
                  Notiflix.Block.remove("[data-item='" + x.dataset.item + "']");
                  userMan.set("metadata", newdata, () => {
                    location.reload();
                  }, ["tuser", "tpass"]);
                }
              });
              x.querySelector(".notiflix-block-message").querySelectorAll("button")[1].addEventListener("click", function() {
                Notiflix.Block.remove("[data-item='" + x.dataset.item + "']");
              });
            }
          });
          // if (userMan.get("metadata").preferences.items.indexOf(x.dataset.item) > -1) {
          //   x.querySelector("h4").innerHTML = "<i class='light'>Owned</i>";
          //   x.classList.add("owned");
          // }
        });
        document.querySelectorAll(".user-points").forEach(x => x.textContent = userMan.get("metadata").points.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
        document.querySelectorAll(".user-items").forEach(x => x.textContent = userMan.get("metadata").preferences.items.length);
      });
    </script>
  </body>
</html>